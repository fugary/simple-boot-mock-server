name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name for the release (e.g., v2.11.1)'
        required: true
        default: 'v'

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build Frontend
        working-directory: simple-boot-mock-newui
        run: |
          npm install -g vite
          npm install --legacy-peer-deps --no-audit --no-fund
          echo "Current directory: $(pwd)"
          ls -F
          npm run build

      - name: Copy Frontend to Backend
        run: |
          mkdir -p simple-boot-mock-server/src/main/resources/static/
          cp -r simple-boot-mock-newui/dist/* simple-boot-mock-server/src/main/resources/static/

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: 'maven'

      - name: Build Backend with Maven
        run: mvn clean install -Dmaven.test.skip=true -Pproduction

      - name: Find Release Artifact
        id: find_artifact
        run: |
          ARTIFACT_PATH=$(find simple-boot-mock-server/target -name "simple-boot-mock-server-*-assembly.zip" | head -n 1)
          echo "artifact_path=$ARTIFACT_PATH" >> $GITHUB_OUTPUT
          echo "Found artifact: $ARTIFACT_PATH"

      - name: Generate Changelog
        id: changelog
        shell: bash
        run: |
          git fetch --tags --force
          CURRENT_TAG=${{ github.event.inputs.tag_name || github.ref_name }}
          PREVIOUS_TAG=$(git tag --sort=-v:refname | grep -A 1 "^${CURRENT_TAG}$" | tail -n 1)
          REPO_URL="https://github.com/fugary/simple-boot-mock-server"
          
          if [ -z "$PREVIOUS_TAG" ] || [ "$PREVIOUS_TAG" == "$CURRENT_TAG" ]; then
            REVISION_RANGE="-n 20"
          else
            REVISION_RANGE="$PREVIOUS_TAG..$CURRENT_TAG"
          fi

          # Function to get and filter logs
          get_logs() {
            local pattern=$1
            local exclude_pattern="github-actions\[bot\]"
            local exclude_msgs="(version:|docs: add github release automation workflow|mvn versions:set|Updating simple-boot-mock-newui version)"
            
            git log --reverse $REVISION_RANGE --pretty=format:"%an|%s|%H" | \
            grep -v "$exclude_pattern" | \
            grep -vE "^[^|]+\|$exclude_msgs" | \
            while IFS='|' read -r author subject hash; do
                # Filter out commits that only modify .github/ or release.yml
                local files=$(git diff-tree --no-commit-id --name-only -r "$hash")
                local non_ignored_count=$(echo "$files" | grep -vE "^(\.github/|release\.yml)" | wc -l)
                if [ "$non_ignored_count" -gt 0 ]; then
                    if [ "$pattern" == "other" ]; then
                        if [[ ! "$subject" =~ ^(feat|fix|bug|opt|dep|test): ]]; then
                            echo "$subject|$hash"
                        fi
                    else
                        if [[ "$subject" =~ ^($pattern): ]]; then
                            echo "$subject|$hash"
                        fi
                    fi
                fi
            done | awk -F'|' '!seen[$1]++'
          }

          format_list() {
            local title=$1
            local data=$2
            if [ -n "$data" ]; then
              echo "### $title" >> changelog.txt
              echo "$data" | awk -F'|' -v url="$REPO_URL" '{print (NR ". [" $1 "](" url "/commit/" $2 ")")}' >> changelog.txt
              echo "" >> changelog.txt
            fi
          }

          echo "## What's Changed" > changelog.txt
          
          FEATS=$(get_logs "feat")
          FIXES=$(get_logs "fix|bug")
          OPTS=$(get_logs "opt")
          DEPS=$(get_logs "dep")
          TESTS=$(get_logs "test")
          OTHERS=$(get_logs "other")

          format_list "ðŸš€ Features" "$FEATS"
          format_list "ðŸ› Bug Fixes" "$FIXES"
          format_list "ðŸ§ª Tests" "$TESTS"
          format_list "âš¡ Optimizations" "$OPTS"
          format_list "ðŸ“¦ Dependencies" "$DEPS"
          format_list "ðŸ“ Other Changes" "$OTHERS"
          
          if [ -n "$PREVIOUS_TAG" ] && [ "$PREVIOUS_TAG" != "$CURRENT_TAG" ]; then
            echo "**Full Changelog**: $REPO_URL/compare/$PREVIOUS_TAG...$CURRENT_TAG" >> changelog.txt
          fi
          
          {
            echo 'body<<EOF'
            cat changelog.txt
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.find_artifact.outputs.artifact_path }}
          tag_name: ${{ github.event.inputs.tag_name || github.ref_name }}
          body: ${{ steps.changelog.outputs.body }}
          generate_release_notes: false
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
