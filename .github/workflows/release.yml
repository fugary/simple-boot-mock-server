name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name for the release (e.g., v2.11.1)'
        required: true
        default: 'v'

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build Frontend
        working-directory: simple-boot-mock-newui
        run: |
          npm install -g vite
          npm install --legacy-peer-deps --no-audit --no-fund
          echo "Current directory: $(pwd)"
          ls -F
          npm run build

      - name: Copy Frontend to Backend
        run: |
          mkdir -p simple-boot-mock-server/src/main/resources/static/
          cp -r simple-boot-mock-newui/dist/* simple-boot-mock-server/src/main/resources/static/

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: 'maven'

      - name: Build Backend with Maven
        run: mvn clean install -Dmaven.test.skip=true -Pproduction

      - name: Find Release Artifact
        id: find_artifact
        run: |
          ARTIFACT_PATH=$(find simple-boot-mock-server/target -name "simple-boot-mock-server-*-assembly.zip" | head -n 1)
          echo "artifact_path=$ARTIFACT_PATH" >> $GITHUB_OUTPUT
          echo "Found artifact: $ARTIFACT_PATH"

      - name: Generate Changelog
        id: changelog
        shell: bash
        run: |
          git fetch --tags --force
          CURRENT_TAG=${{ github.event.inputs.tag_name || github.ref_name }}
          # Find the previous tag
          PREVIOUS_TAG=$(git tag --sort=-v:refname | grep -A 1 "^${CURRENT_TAG}$" | tail -n 1)
          
          echo "## What's Changed" > changelog.txt
          if [ -z "$PREVIOUS_TAG" ] || [ "$PREVIOUS_TAG" == "$CURRENT_TAG" ]; then
            REVISION_RANGE="-n 20"
          else
            REVISION_RANGE="$PREVIOUS_TAG..$CURRENT_TAG"
          fi

          # Get logs, filter by author and message patterns, de-duplicate by subject (keep oldest), and format
          git log --reverse $REVISION_RANGE --pretty=format:"%an|%s|%H" | \
          grep -v "github-actions\[bot\]" | \
          grep -vE "^[^|]+\|(version:|docs: add github release automation workflow|mvn versions:set|Updating simple-boot-mock-newui version)" | \
          awk -F'|' '!seen[$2]++ {
            count++;
            print count ". [" $2 "](https://github.com/fugary/simple-boot-mock-server/commit/" $3 ")"
          }' >> changelog.txt
          
          echo "" >> changelog.txt
          if [ -n "$PREVIOUS_TAG" ] && [ "$PREVIOUS_TAG" != "$CURRENT_TAG" ]; then
            echo "**Full Changelog**: https://github.com/fugary/simple-boot-mock-server/compare/$PREVIOUS_TAG...$CURRENT_TAG" >> changelog.txt
          fi
          
          {
            echo 'body<<EOF'
            cat changelog.txt
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.find_artifact.outputs.artifact_path }}
          tag_name: ${{ github.event.inputs.tag_name || github.ref_name }}
          body: ${{ steps.changelog.outputs.body }}
          generate_release_notes: false
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
